name: ATG JIT Odds Monitor

on:
  schedule:
    - cron: '30 8 * * *'   # 10:00 CET (Lunch/EM)
    - cron: '30 14 * * *' # 15:30 CET (EM/Kväll)
    - cron: '30 17 * * *' # 18:30 CET (Sen kväll - täcker till 00:30)
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 360 # GitHub max 6 timmar
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          pip install requests pandas
        
      - name: Run JIT Odds Monitor
        env:
          MONITOR_DURATION_HOURS: 6
        run: |
          export PYTHONPATH=.
          # Kör bevakaren i bakgrunden och spara loggen till fil
          python3 src/data/odds_monitor.py > monitor.log 2>&1 &
          
          # En loop som pushar data löpande var 10:e minut
          while kill -0 $! 2>/dev/null; do
            sleep 600
            git config --global user.name "GitHub Action"
            git config --global user.email "action@github.com"
            git pull --rebase origin master || echo "Rebase failed, skipping this push"
            git add data/warehouse/bronze/
            git commit -m "Automated JIT odds snapshot [skip ci]" || echo "No changes"
            git push origin master || echo "Push failed, retrying"
            
            # Visa de senaste raderna i loggen för webb-vyn
            echo "--- Latest log entries ---"
            tail -n 20 monitor.log
          done
          
          # En sista push när processen avslutas
          git pull --rebase origin master || echo "Final rebase failed"
          git add data/warehouse/bronze/
          git commit -m "Final JIT odds snapshot for session [skip ci]" || echo "No changes"
          git push origin master || echo "Final push failed"
